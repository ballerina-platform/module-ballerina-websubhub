version: '2'

services:
    lb:
        image: 'ballerina/loadbalancersvc:v1'
        container_name: lb
        ports:
            - '9090:9090'
        depends_on:
            hub-1:
                condition: service_healthy
                restart: true
            hub-2:
                condition: service_healthy
                restart: true
        network_mode: "host"

    hub-1:
        image: 'ballerina/kafkahub:v1'
        container_name: hub-1
        depends_on:
            consolidator:
                condition: service_healthy
                restart: true
            idp:
                condition: service_started
        environment:
            HUB_PORT: 9000
            SERVER_ID: "server-1"
            KAFKA_BOOTSTRAP_NODE: "localhost:9094"
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --no-check-certificate --tries=1 --spider 'https://localhost:9000/health' || exit 1"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 10
        network_mode: "host"
        volumes:
            # Kafka broker certificate
            - /path/to/broker.public.crt:/home/ballerina/resources/brokercerts/broker.public.crt
            # Kafka client certificate
            - /path/to/client.public.crt:/home/ballerina/resources/brokercerts/client.public.crt
            # Kafka client key
            - /path/to/client.private.key:/home/ballerina/resources/brokercerts/client.private.key
    
    hub-2:
        image: 'ballerina/kafkahub:v1'
        container_name: hub-2
        depends_on:
            consolidator:
                condition: service_healthy
                restart: true
            idp:
                condition: service_started
        environment:
            HUB_PORT: 9001
            SERVER_ID: "server-2"
            KAFKA_BOOTSTRAP_NODE: "localhost:9094"
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --no-check-certificate --tries=1 --spider 'https://localhost:9001/health' || exit 1"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 10
        network_mode: "host"
        volumes:
            # Kafka broker certificate
            - /path/to/broker.public.crt:/home/ballerina/resources/brokercerts/broker.public.crt
            # Kafka client certificate
            - /path/to/client.public.crt:/home/ballerina/resources/brokercerts/client.public.crt
            # Kafka client key
            - /path/to/client.private.key:/home/ballerina/resources/brokercerts/client.private.key

    consolidator: 
        image: 'ballerina/consolidator:v1'
        container_name: consolidator
        ports:
            - '10001:10001'
        environment:
            KAFKA_BOOTSTRAP_NODE: "localhost:9094"
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider 'http://localhost:10001/health/readiness' || exit 1"]
            interval: 30s
            timeout: 10s
            start_period: 30s
            retries: 10
        network_mode: "host"
        volumes:
            # Kafka broker certificate
            - /path/to/broker.public.crt:/home/ballerina/resources/brokercerts/broker.public.crt
            # Kafka client certificate
            - /path/to/client.public.crt:/home/ballerina/resources/brokercerts/client.public.crt
            # Kafka client key
            - /path/to/client.private.key:/home/ballerina/resources/brokercerts/client.private.key

    idp:
        image: 'ayeshalmeida/wso2-is:5.11.0.update'
        container_name: idp
        ports:
            - '9443:9443'
        network_mode: "host"
